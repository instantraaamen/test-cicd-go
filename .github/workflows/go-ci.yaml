name: Go CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Goã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.1'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: go mod download

    - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèªï¼ˆgofmtï¼‰
      run: |
        if [ "$(gofmt -l .)" ]; then
          echo "ã‚³ãƒ¼ãƒ‰ãŒgofmtã«æº–æ‹ ã—ã¦ã„ã¾ã›ã‚“"
          exit 1
        fi

    - name: golangci-lintã‚’ä½¿ã£ãŸé™çš„è§£æ
      uses: golangci/golangci-lint-action@v4
      with:
        version: v1.64.6

    - name: ã‚³ãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ç¢ºèª
      run: go build -v ./...

    - name: ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆé–¾å€¤80%ï¼‰
      run: |
        go test -coverprofile=coverage.out ./...
        coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
        echo "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ ${coverage}% ã§ã™ã€‚"
        if (( $(echo "$coverage < 80.0" | bc -l) )); then
          echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%æœªæº€ã®ãŸã‚å¤±æ•—ã—ã¾ã—ãŸã€‚"
          exit 1
        fi

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’æˆæœç‰©ã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.out

    - name: Slacké€šçŸ¥ï¼ˆæˆåŠŸæ™‚ï¼‰
      if: success()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_MESSAGE: "âœ… Goãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"

    - name: Slacké€šçŸ¥ï¼ˆå¤±æ•—æ™‚ï¼‰
      if: failure()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_COLOR: danger
        SLACK_MESSAGE: "âš ï¸ ãƒ†ã‚¹ãƒˆã¾ãŸã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼"

    - name: PRã‚³ãƒ¡ãƒ³ãƒˆã§ã‚«ãƒãƒ¬ãƒƒã‚¸é€šçŸ¥
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: coverage-report
        message: |
          ## ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ ğŸ“Š
          - ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ `${{ env.coverage }}%` ã§ã™ã€‚
